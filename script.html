<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vAtom 1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-900 text-gray-200">
    <div class="flex flex-col flex-grow w-full max-w-2xl h-[80vh] bg-gray-800 rounded-xl shadow-xl overflow-hidden">
        <!-- Chat messages container -->
        <div id="messages" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Messages will appear here. -->
        </div>

        <!-- Input form -->
        <form id="chat-form" class="flex-shrink-0 p-4 bg-gray-700 flex items-center gap-2 rounded-b-xl">
            <input type="file" id="file-upload" accept=".json" class="hidden">
            <label for="file-upload" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-full transition duration-300 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            </label>
            <input id="user-input" type="text" placeholder="Type your message..." class="flex-grow rounded-full text-white bg-gray-600 border-none px-4 py-2 focus:outline-none">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                </svg>
            </button>
        </form>
    </div>

    <script>
        // Key for localStorage
        const STORAGE_KEY = 'chatbotKnowledge';
        
        // Load the knowledge from localStorage or use a default if it doesn't exist.
        function loadKnowledge() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                return JSON.parse(savedData);
            }
            return { "hello": "Hello! What can I help you with?" };
        }

        // Save the knowledge to localStorage.
        function saveKnowledge(knowledge) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(knowledge));
        }

        let knowledge = loadKnowledge();

        // Get references to the HTML elements.
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const messagesContainer = document.getElementById('messages');
        const fileUpload = document.getElementById('file-upload');

        let isLearning = false;
        let lastUnknownMessage = '';

        // Helper function to add a message to the chat window.
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'p-3', 'rounded-lg', 'max-w-xs', 'word-wrap', 'break-all');
            
            if (sender === 'user') {
                messageDiv.classList.add('bg-blue-600', 'text-white', 'self-end', 'rounded-br-none');
            } else {
                messageDiv.classList.add('bg-gray-700', 'text-gray-200', 'rounded-bl-none');
            }
            
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Handles the core logic for the chatbot.
        function getResponse(userMessage) {
            const user_input = userMessage.toLowerCase().trim();
            for (const keyword in knowledge) {
                if (user_input.includes(keyword)) {
                    return knowledge[keyword];
                }
            }
            return "unknown";
        }

        // Event listener for file upload
        fileUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (file.type !== 'application/json') {
                addMessage("Invalid file type. Please upload a .json file.", 'ai');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const uploadedData = JSON.parse(e.target.result);
                    // Merge uploaded data with existing knowledge
                    knowledge = { ...knowledge, ...uploadedData };
                    saveKnowledge(knowledge);
                    addMessage("Knowledge base updated successfully from file!", 'ai');
                } catch (error) {
                    addMessage("Failed to process the JSON file. Please check the format.", 'ai');
                    console.error('File parsing error:', error);
                }
            };
            reader.onerror = (error) => {
                addMessage("Failed to read the file.", 'ai');
                console.error('File reading error:', error);
            };
            reader.readAsText(file);
        });

        // The event listener for the form submission.
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevents the page from reloading.

            const userMessage = userInput.value.trim();

            if (userMessage === '') {
                return;
            }

            userInput.value = '';
            addMessage(userMessage, 'user');

            if (isLearning) {
                // If the AI is in "learning" mode, save the new knowledge.
                const keyword = lastUnknownMessage;
                const answer = userMessage;
                
                knowledge[keyword.toLowerCase()] = answer;
                saveKnowledge(knowledge); // Now we save the new knowledge!
                addMessage("Thank you! I have learned something new.", 'ai');
                
                isLearning = false;
                lastUnknownMessage = '';

            } else {
                // Otherwise, get a response from the knowledge base.
                const response = getResponse(userMessage);

                if (response === 'unknown') {
                    addMessage("I am sorry, I don't know the answer to that. Please type the correct answer to teach me.", 'ai');
                    isLearning = true;
                    lastUnknownMessage = userMessage;
                } else {
                    addMessage(response, 'ai');
                }
            }
        });
    </script>
</body>
</html>

